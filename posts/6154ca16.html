<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>从URL输入到页面展现到底发生什么？ | Leslie Waong</title><meta name="keywords" content="HTTP,TCP,DNS,浏览器渲染,回流重绘"><meta name="author" content="Leslie Waong"><meta name="copyright" content="Leslie Waong"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="从URL输入到页面展现到底发生什么？ 总体来说分为以下几个过程:  解析URL并生成请求报文 DNS 解析：将域名解析成IP地址 TCP 三次握手、TLS三次握手 &#x3D;》在HTTPS上建立安全连接 发送HTTP请求 服务器处理请求并返回 HTTP 报文 浏览器解析渲染页面 断开连接：TCP四次挥手  URL解析并生成HTTP请求消息首先浏览器做的第一步工作就是要对URL进行解析，从而生成发送给Web"><meta property="og:type" content="article"><meta property="og:title" content="从URL输入到页面展现到底发生什么？"><meta property="og:url" content="https://lesliewaong.top/posts/6154ca16.html"><meta property="og:site_name" content="Leslie Waong"><meta property="og:description" content="从URL输入到页面展现到底发生什么？ 总体来说分为以下几个过程:  解析URL并生成请求报文 DNS 解析：将域名解析成IP地址 TCP 三次握手、TLS三次握手 &#x3D;》在HTTPS上建立安全连接 发送HTTP请求 服务器处理请求并返回 HTTP 报文 浏览器解析渲染页面 断开连接：TCP四次挥手  URL解析并生成HTTP请求消息首先浏览器做的第一步工作就是要对URL进行解析，从而生成发送给Web"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/1.webp"><meta property="article:published_time" content="2022-03-03T05:14:52.000Z"><meta property="article:modified_time" content="2022-03-25T14:08:26.420Z"><meta property="article:author" content="Leslie Waong"><meta property="article:tag" content="HTTP"><meta property="article:tag" content="TCP"><meta property="article:tag" content="DNS"><meta property="article:tag" content="浏览器渲染"><meta property="article:tag" content="回流重绘"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/1.webp"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/avatar.jpg"><link rel="canonical" href="https://lesliewaong.top/posts/6154ca16"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},noticeOutdate:{limitDay:365,position:"top",messagePrev:"一年之内的产物",messageNext:"技术可能存在过期"},highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:200},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:50,languages:{author:"作者: Leslie Waong",link:"链接: ",source:"来源: Leslie Waong",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"bottom-left"},source:{jQuery:"https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js",justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js",css:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css"},fancybox:{js:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js",css:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isanchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"从URL输入到页面展现到底发生什么？",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-03-25 22:08:26"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme");"dark"===t?activateDarkMode():"light"===t&&activateLightMode();const o=saveToLocal.get("aside-status");void 0!==o&&("hide"===o?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));const n=saveToLocal.get("global-font-size");void 0!==n&&document.documentElement.style.setProperty("--global-font-size",n+"px");const a=()=>{GLOBAL_CONFIG_SITE.isHome&&/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")};a(),document.addEventListener("pjax:complete",a)})(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Leslie Waong" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/avatar.jpg" onerror='onerror=null,src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/friend_404.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-archive"></i><span> 归档</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fas fa-book"></i><span> 说说</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-heartbeat"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/List/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/List/gallery/"><i class="fa-fw fa fa-image"></i><span> 相册</span></a></li><li><a class="site-page child" href="/List/movies/"><i class="fa-fw fa fa-film"></i><span> 视频</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/tools/"><i class="fa-fw fa fa-suitcase"></i><span> 百宝箱</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 项目</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/item/Naruto/"><i class="fa-fw fa fa-star"></i><span> 火影</span></a></li><li><a class="site-page child" href="/react-admin-client"><i class="fa-fw fa fa-star"></i><span> One Piece</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/bangumis/"><i class="fa-fw fa fa-desktop"></i><span> BiliBili</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/1.webp)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Leslie Waong</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-archive"></i><span> 归档</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fas fa-book"></i><span> 说说</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-heartbeat"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/List/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/List/gallery/"><i class="fa-fw fa fa-image"></i><span> 相册</span></a></li><li><a class="site-page child" href="/List/movies/"><i class="fa-fw fa fa-film"></i><span> 视频</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/tools/"><i class="fa-fw fa fa-suitcase"></i><span> 百宝箱</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 项目</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/item/Naruto/"><i class="fa-fw fa fa-star"></i><span> 火影</span></a></li><li><a class="site-page child" href="/react-admin-client"><i class="fa-fw fa fa-star"></i><span> One Piece</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/bangumis/"><i class="fa-fw fa fa-desktop"></i><span> BiliBili</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">从URL输入到页面展现到底发生什么？</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-03-03T05:14:52.000Z" title="发表于 2022-03-03 13:14:52">2022-03-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-03-25T14:08:26.420Z" title="更新于 2022-03-25 22:08:26">2022-03-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/">浏览器</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">11.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>33分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="从URL输入到页面展现到底发生什么？"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="从URL输入到页面展现到底发生什么？"><a href="#从URL输入到页面展现到底发生什么？" class="headerlink" title="从URL输入到页面展现到底发生什么？"></a>从URL输入到页面展现到底发生什么？</h1><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/btVsO0"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s4.ax1x.com/2022/03/03/btVsO0.png" alt="btVsO0.png"></a></p><p>总体来说分为以下几个过程:</p><ul><li>解析URL并生成请求报文</li><li>DNS 解析：将域名解析成IP地址</li><li>TCP 三次握手、TLS三次握手 =》在HTTPS上建立安全连接</li><li>发送HTTP请求</li><li>服务器处理请求并返回 HTTP 报文</li><li>浏览器解析渲染页面</li><li>断开连接：TCP四次挥手</li></ul><h2 id="URL解析并生成HTTP请求消息"><a href="#URL解析并生成HTTP请求消息" class="headerlink" title="URL解析并生成HTTP请求消息"></a>URL解析并生成HTTP请求消息</h2><p>首先浏览器做的第一步工作就是要对URL进行解析，从而生成发送给Web服务器的请求信息。</p><h3 id="URL是什么？"><a href="#URL是什么？" class="headerlink" title="URL是什么？"></a>URL是什么？</h3><blockquote><p>URI 和 URL</p><ul><li>URI(Uniform Resource Identifier) 是<strong>统一资源标志符</strong>，可以<strong>唯一标识一个资源</strong>。</li><li>URL(Uniform Resource Locator) 是<strong>统一资源定位符</strong>，可以提供该资源的<strong>路径</strong>。它是一种具体的 URI，即 <strong>URL 可以用来标识一个资源，而且还指明了如何 locate 这个资源</strong>。</li></ul><p>URI 的作用像身份证号一样，URL 的作用更像家庭住址一样。<strong>URL 是一种具体的 URI，它不仅唯一标识资源，而且还提供了定位该资源的信息。</strong></p></blockquote><p>URL遵守以下的语法规则：<code>scheme://host.domain:port/path/filename</code></p><ul><li><strong>scheme</strong> - 定义因特网服务的类型。常见的协议有 <strong>http、https、ftp、file</strong>，其中最常见的类型是 http，而 <strong>https 则是进行加密的网络传输</strong>。</li><li><strong>host</strong> - 定义域主机（http 的默认主机是 <strong>www</strong>）</li><li><strong>domain</strong> - 定义因特网<strong>域名</strong>，比如 <code>w3school.com.cn</code></li><li><strong>port</strong> - 定义主机上的<strong>端口号</strong>（http 的默认端口号是 80）</li><li><strong>path</strong> - 定义服务器上的路径（如果省略，则文档必须位于网站的根目录中）。</li><li><strong>filename</strong> - 定义文档/资源的名称</li></ul><p>当没有路径名时，就代表访问根目录下事先设置的默认文件，也就是<code>/index.html</code>或者<code>/default.html</code>这些文件，这样就不会发生混乱了。</p><h3 id="生成HTTP请求消息"><a href="#生成HTTP请求消息" class="headerlink" title="生成HTTP请求消息"></a>生成HTTP请求消息</h3><p>对URL进行解析之后，浏览器确定了Web服务器和文件名，接下来就是根据这些信息来生成HTTP请求消息了。</p><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/btZlAU"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s4.ax1x.com/2022/03/03/btZlAU.png" alt="btZlAU.png"></a></p><h2 id="域名解析（DNS）"><a href="#域名解析（DNS）" class="headerlink" title="域名解析（DNS）"></a>域名解析（DNS）</h2><p>通过浏览器解析URL并生成HTTP消息后，需要委托操作系统将消息发送给Web服务器。</p><p>但在发送之前，还有一项工作需要完成，那就是<strong>查询服务器域名对应的IP地址，因为委托操作系统发送消息时，必须提供通信对象的IP地址。</strong></p><p>比如我们打电话的时候，必须要知道对方的电话号码，但由于电话号码难以记忆，所以通常我们会将对方电话号+姓名保存在通讯录里。</p><p>所以，有一种服务器就<strong>专门保存了Web服务器域名与IP的对应关系</strong>，它就是<strong>DNS服务器</strong>。</p><h3 id="域名的层级关系"><a href="#域名的层级关系" class="headerlink" title="域名的层级关系"></a>域名的层级关系</h3><p>DNS 中的域名都是用<strong>句点</strong>来分隔的，比 <a target="_blank" rel="noopener" href="http://www.serve.com,在域名中,**越靠右的位置表示其层级越高./">www.Serve.com，在域名中，**越靠右的位置表示其层级越高。</a>**</p><p>根域的DNS 服务器信息保存在互联网中所有的 DNS服务器中。</p><p>这样一来，任何DNS服务器就都可以找到并访问根域 DNS服务器了。</p><p>因此，客户端只要能够找到任意一台DNS服务器，就可以通过它找到根域DNS服务器，然后再一路顺藤摸瓜找到位于下层的某台目标 DNS服务器。</p><h3 id="IP-地址"><a href="#IP-地址" class="headerlink" title="IP 地址"></a>IP 地址</h3><p>IP 地址是指互联网协议地址，是 IP Address 的缩写。</p><p>IP 地址是 IP 协议提供的一种统一的地址格式，它为<strong>互联网上的每一个网络和每一台主机分配一个逻辑地址</strong>，以此来屏蔽物理地址的差异。IP 地址是一个 32 (8*4)位的二进制数，比如 127.0.0.1 为本机 IP。</p><p><strong>域名就相当于 IP 地址乔装打扮的伪装者，带着一副面具。它的作用就是便于记忆和沟通的一组服务器的地址</strong>。</p><p>用户通常使用主机名或域名来访问对方的计算机，而不是直接通过 IP 地址访问。</p><p>因为与 IP 地址的一组纯数字相比，用字母配合数字的表示形式来指定计算机名更符合人类的记忆习惯。</p><p>但要让计算机去理解名称，相对而言就变得困难了。</p><p>因为计算机更擅长处理一长串数字。为了解决上述的问题，DNS 服务应运而生。</p><h3 id="什么是域名解析"><a href="#什么是域名解析" class="headerlink" title="什么是域名解析"></a>什么是域名解析</h3><p>DNS 协议提供通过域名查找 IP 地址，或逆向从 IP 地址反查域名的服务。</p><p><strong>DNS 是一个网络服务器，我们的域名解析简单来说就是在 DNS 上记录一条信息记录</strong>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">例如 baidu.com  220.114.23.56（服务器外网IP地址）80（服务器端口号）</span><br></pre></td></tr></table></figure><h3 id="浏览器如何通过域名去查询-URL-对应的-IP-呢"><a href="#浏览器如何通过域名去查询-URL-对应的-IP-呢" class="headerlink" title="浏览器如何通过域名去查询 URL 对应的 IP 呢"></a>浏览器如何通过域名去查询 URL 对应的 IP 呢</h3><ul><li>浏览器缓存：浏览器会按照一定的频率缓存 DNS 记录。</li><li>操作系统缓存：如果浏览器缓存中找不到需要的 DNS 记录，那就去操作系统中找。</li><li>路由缓存：路由器也有 DNS 缓存。</li><li>ISP 的 DNS 服务器：ISP 是互联网服务提供商(Internet Service Provider)的简称，ISP 有专门的 DNS 服务器应对 DNS 查询请求。</li><li>根服务器：ISP 的 DNS 服务器还找不到的话，它就会向根服务器发出请求，进行递归查询。</li></ul><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/btevLt"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s4.ax1x.com/2022/03/03/btevLt.png" alt="btevLt.png"></a></p><p>DNS域名解析的过程蛮有意思的，整个过程就和我们日常生活中找人问路的过程类似，只指路不带路。</p><h3 id="DNS负载均衡"><a href="#DNS负载均衡" class="headerlink" title="DNS负载均衡"></a>DNS负载均衡</h3><p>比如访问baidu.com的时候，每次响应的并非是同一个服务器（IP地址不同），一般大公司都有成百上千台服务器来支撑访问。DNS可以返回一个合适的机器的IP给用户，例如可以根据每台机器的负载量，该机器离用户地理位置的距离等等，这种过程就是DNS负载均衡。</p><h2 id="协议栈"><a href="#协议栈" class="headerlink" title="协议栈"></a>协议栈</h2><p>通过DNS获取到IP后，就可以把 HTTP的传输工作交给<strong>操作系统中的协议栈</strong>。</p><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/btmiWQ"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s4.ax1x.com/2022/03/03/btmiWQ.png" alt="btmiWQ.png"></a></p><p>应用程序（浏览器）通过调用Socket库，来委托协议栈工作。</p><p>协议栈的上半部分有两块，分别是负责收发数据的<strong>TCP</strong>和<strong>UDP</strong>协议，它们会<strong>接受应用层的委托执行收发数据的操作</strong>。</p><p>协议栈的下面一半是用<strong>IP</strong>协议<strong>控制网络包收发操作</strong>，在互联网上传数据时，数据会被切分成一块块的网络包，而将网络包发送给对方的操作就是由IP负责的。</p><p>此外IP中还包括ICMP协议和ARP协议。</p><ul><li><strong>ICMP</strong>用于告知网络包传送过程中<strong>产生的错误</strong>以及各种<strong>控制信息</strong>。</li><li><strong>ARP</strong>用于根据<strong>IP地址</strong>查询相应的<strong>以太网MAC地址</strong>。</li></ul><p>IP下面的<strong>网卡驱动程序负责控制网卡硬件</strong>，而最下面的网卡则负责完成<strong>实际的收发操作</strong>，也就是对网线中的信号执行发送和接收操作。</p><h3 id="TCP三次握手"><a href="#TCP三次握手" class="headerlink" title="TCP三次握手"></a>TCP三次握手</h3><p>在HTTP传输数据之前，首先需要TCP建立连接，TCP连接的建立，通常称为三次握手。</p><p>这个所谓的「连接」，只是双方计算机里<strong>维护一个状态机</strong>。</p><blockquote><p>我们来看看RFC 793是如何定义「连接」的:</p></blockquote><p>简单来说就是，<strong>用于保证可靠性和流量控制维护的某些状态信息，这些信息的组合，包括Socket、序列号和窗口大小称为连接。</strong></p><p>所以我们可以知道，建立一个TCP连接是需要客户端与服务器端达成上述三个信息的共识。</p><ul><li><strong>Socket</strong>:由<strong>IP地址</strong>和<strong>端口号</strong>组成</li><li><strong>序列号</strong>:用来解决乱序问题等</li><li><strong>窗口大小</strong>:用来做流量控制</li></ul><h4 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h4><p>首先，<strong>源端口号</strong>和<strong>目标端口号</strong>是不可少的，如果没有这两个端口号，数据就不知道应该发给哪个应用。</p><p>接下来有包的<strong>序号</strong>，这个是为了<strong>解决包乱序的问题</strong>。</p><p>还有就是<strong>确认号</strong>，目的是确认发出去对方是否有收到。如果没有收到就应该重新发送，直到送达，这个是为了<strong>解决不丢包的问题</strong>。</p><p>接下来还有一些状态位。例如<code>SYN</code>是发起一个连接，<code>ACK</code>是回复，<code>RST</code>是重新连接，<code>FIN</code>是结束连接等。</p><p>TCP是<strong>面向连接</strong>的，因而双方要<strong>维护连接的状态</strong>，这些带状态位的包的发送，会引起双方的状态变更。</p><p>还有一个重要的就是<strong>窗口大小</strong>。TCP要做<strong>流量控制</strong>，通信双方各声明一个窗口(缓存大小) ,标识自己当前能够的处理能力，别发送的太快，撑死我，也别发的太慢，饿死我。</p><p>除了做流量控制以外，TCP还会做<strong>拥塞控制</strong>，对于真正的通路堵车不堵车，它无能为力，唯一能做的就是控制自己，也即控制发送的速度。不能改变世界，就改变自己嘛。</p><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/btm5lj"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s4.ax1x.com/2022/03/03/btm5lj.png" alt="btm5lj.png"></a></p><h4 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h4><ul><li>一开始，客户端和服务端都处于<code>CLOSED</code>状态。先是服务端主动监听某个端口，处于<code>LISTEN</code>状态。</li><li>客户端会随机初始化序号（<code>client_isn</code> ) ，将此序号置于TCP首部的<strong>序号</strong>字段中，同时把<code>SYN</code> 标志位置为<code>1</code> ，表示 SYN 报文。接着把<strong>第一个SYN 报文发送给服务端</strong>，表示向服务端发起连接，该报文<strong>不包含应用层数据</strong>，之后客户端处于<code>SYN-SENT</code>状态。</li><li>服务端收到客户端的<code>SYN</code>报文后，也随机初始化自己的序号（<code>server_isn</code> )，将此序号填入TCP首部的<strong>序号</strong>字段中，其次把TCP首部的<strong>确认应答号</strong>字段填入<code>client_isn +1</code> ,接着把<code>SYN</code>和<code>ACK</code>标志位置为<code>1</code>。最后把该报文发给客户端，该报文<strong>也不包含应用层数据</strong>，之后服务端处于<code>SYN-RCVD</code>状态。</li><li>客户端收到服务端报文后，还要向服务端回应最后一个应答报文，首先该应答报文TCP首部<code>ACK</code>标志位置为<code>1</code>，其次<strong>确认应答号</strong>字段填入<code>server_isn +1</code> ，最后把报文发送给服务端，这次报文<strong>可以携带客户到服务器的数据</strong>，之后客户端处于<code>ESTABLISHED</code> 状态。</li><li>服务器收到客户端的应答报文后，也进入<code>ESTABLISHED</code>状态。</li></ul><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/btndH0"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s4.ax1x.com/2022/03/03/btndH0.png" alt="btndH0.png"></a></p><h4 id="为什么是三次握手-不是两次、四次"><a href="#为什么是三次握手-不是两次、四次" class="headerlink" title="为什么是三次握手?不是两次、四次?"></a>为什么是三次握手?不是两次、四次?</h4><p>相信大家比较常回答的是︰“<strong>因为三次握手才能保证双方具有接收和发送的能力</strong>。”</p><p>这回答是没问题，但这回答是片面的，并没有说出主要的原因。</p><p>在前面我们知道了什么是TCP连接:</p><p>用于保证可靠性和流量控制维护的某些状态信息，这些信息的组合，包括Socket、序列号和窗口大小称为连接。</p><p>所以，重要的是为什么三次握手才可以<strong>初始化Socket、序列号和窗口大小并建立TCP连接</strong>。</p><p>接下来以三个方面分析三次握手的原因:</p><ul><li>三次握手才可以<strong>阻止重复历史连接的初始化（主要原因)</strong></li><li>三次握手才可以<strong>同步双方的初始序列号</strong></li><li>三次握手才可以<strong>避免资源浪费</strong></li></ul><h5 id="避免历史连接"><a href="#避免历史连接" class="headerlink" title="避免历史连接"></a>避免历史连接</h5><p>简单来说，三次握手的首要原因是<strong>为了防止旧的重复连接初始化造成混乱</strong>。</p><p>客户端连续发送多次SYN建立连接的报文，在网络拥堵情况下:</p><ul><li>一个<strong>旧SYN报文</strong>比<strong>最新的SYN</strong>报文早到达了服务端;</li><li>那么此时服务端就会回一个<strong>SYN</strong> +<strong>ACK</strong>报文给客户端;</li><li>客户端收到后可以根据自身的上下文，判断这是一个历史连接（序列号过期或超时)，那么客户端就会发送<strong>RST</strong>报文给服务端，表示中止这一次连接。</li></ul><p>如果是两次握手连接，就不能判断当前连接是否是历史连接，三次握手则可以在客户端（发送方）准备发送第三次报文时，客户端因有足够的上下文来判断当前连接是否是历史连接︰</p><ul><li>如果是历史连接（序列号过期或超时)，则第三次握手发送的报文是RST报文，以此中止历史连接;</li><li>如果不是历史连接，则第三次发送的报文是ACK报文，通信双方就会成功建立连接</li></ul><h5 id="同步双方初始序列号"><a href="#同步双方初始序列号" class="headerlink" title="同步双方初始序列号"></a>同步双方初始序列号</h5><p>TCP协议的通信双方，都必须维护一个<strong>序列号</strong>，序列号是可靠传输的一个关键因素，它的作用:</p><ul><li>接收方可以<strong>去除重复的数据</strong>;</li><li>接收方可以根据数据包的序列号<strong>按序接收</strong>;</li><li>可以<strong>标识</strong>发送出去的数据包中，哪些是已经被对方收到的;</li></ul><p>可见，序列号在TCP 连接中占据着非常重要的作用，所以当<strong>客户端</strong>发送携带<strong>初始序列号</strong>的 <strong>SYN</strong> 报文的时候，需要<strong>服务端</strong>回一个<strong>ACK应答报文</strong>，表示客户端的SYN报文已被服务端成功接收，那当<strong>服务端</strong>发送<strong>初始序列号</strong>给客户端的时候，依然也要得到<strong>客户端的应答回应</strong>，这样一来一回，才能确保双方的初始序列号能被可靠的同步。</p><p>两次握手<strong>只保证了一方的初始序列号能被对方成功接收，没办法保证双方的初始序列号都能被确认接收</strong>。</p><h5 id="避免资源浪费"><a href="#避免资源浪费" class="headerlink" title="避免资源浪费"></a>避免资源浪费</h5><p>如果只有<strong>两次握手</strong>，当客户端的SYN请求连接在网络中阻塞，客户端没有接收到<strong>ACK</strong>报文，就会重新发送<strong>SYN</strong> ，由于没有第三次握手，服务器不清楚客户端是否收到了自己发送的建立连接的 <strong>ACK</strong>确认信号，所以每收到一个<strong>SYN</strong>就只能先主动建立一个连接，这会造成什么情况呢?</p><p>如果客户端的SYN 阻塞了，重复发送多次SYN 报文，那么服务器在收到请求后就会<strong>建立多个冗余的无效链接，造成不必要的资源浪费。</strong></p><h5 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h5><p><strong>TCP建立连接时，通过三次握手能防止历史连接的建立，能减少双方不必要的资源开销，能帮助双方同步初始化序列号。序列号能够保证数据包不重复、不丢弃和按序传输。</strong></p><p>不使用<strong>两次握手</strong>和<strong>四次握手</strong>的原因:</p><ul><li>两次握手︰无法防止历史连接的建立，会造成双方资源的浪费，也无法可靠的同步双方序列号;</li><li>四次握手︰三次握手就已经理论上最少可靠连接建立，所以不需要使用更多的通信次数。</li></ul><blockquote><p>为什么客户端和服务端的初始序列号ISN是不相同的?</p></blockquote><p>如果一个已经失效的连接被重用了，但是该旧连接的历史报文还残留在网络中，如果序列号相同，那么就无法分辨出该报文是不是历史报文，如果历史报文被新的连接接收了，则会产生数据错乱。</p><p>所以，每次建立连接前重新初始化一个序列号主要是为了<strong>通信双方能够根据序号将不属于本连接的报文段丢弃</strong>。</p><p>另一方面是为了<strong>安全性</strong>，防止黑客伪造的相同序列号的TCP报文被对方接收。</p><h4 id="TCP分割数据"><a href="#TCP分割数据" class="headerlink" title="TCP分割数据"></a>TCP分割数据</h4><p>如果HTTP请求消息比较长，超过了<strong>MSS</strong>的长度，这时TCP就需要把HTTP的数据拆解成一块块的数据发送，而不是一次性发送所有数据。</p><ul><li>MTU :一个网络包的最大长度，以太网中一般为1500字节。</li><li>MSS:除去IP和TCP头部之后，一个网络包所能容纳的TCP数据的最大长度。</li></ul><p>数据会被以<strong>MSS</strong>的长度为单位进行拆分，拆分出来的每一块数据都会被放进单独的网络包中。也就是在每个被拆分的数据加上TCP头信息，然后<strong>交给IP模块来发送数据</strong>。</p><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/btKOtf"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s4.ax1x.com/2022/03/03/btKOtf.png" alt="btKOtf.png"></a></p><h4 id="TCP报文生成"><a href="#TCP报文生成" class="headerlink" title="TCP报文生成"></a>TCP报文生成</h4><p>TCP协议里面会有两个端口，一个是浏览器监听的端口（(通常是随机生成的)，一个是Web服务器监听的端口(<strong>HTTP</strong>默认端口号是<strong>80</strong> ,<strong>HTTPS</strong>默认端口号是<strong>443</strong> ) 。</p><p>在双方建立了连接后，TCP报文中的数据部分就是存放HTTP头部＋数据，组装好TCP报文之后，就需交给下面的<strong>网络层</strong>处理。</p><h3 id="TLS-协商"><a href="#TLS-协商" class="headerlink" title="TLS 协商"></a>TLS 协商</h3><p>为了在HTTPS上建立<strong>安全连接</strong>，另一种握手是必须的。更确切的说是TLS协商 ，它决定了什么密码将会被用来加密通信，验证服务器，在进行真实的数据传输之前建立安全连接。在发送真正的请求内容之前还需要<strong>三次</strong>往返服务器。</p><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/btMsC8"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s4.ax1x.com/2022/03/03/btMsC8.jpg" alt="btMsC8.jpg"></a></p><p>虽然建立安全连接对增加了加载页面的等待时间，对于建立一个安全的连接来说，以增加等待时间为代价是值得的，因为在浏览器和web服务器之间传输的数据不可以被第三方解密。</p><p>经过8次往返，浏览器终于可以发出请求。</p><h3 id="TCP慢开始和拥塞控制"><a href="#TCP慢开始和拥塞控制" class="headerlink" title="TCP慢开始和拥塞控制"></a>TCP慢开始和拥塞控制</h3><p>一旦我们建立了到web服务器的连接，浏览器就代表用户发送一个初始的HTTP GET请求，对于网站来说，这个请求通常是一个HTML文件。 一旦服务器收到请求，它将使用相关的响应头和HTML的内容进行回复。</p><p>初始请求的响应包含所接收数据的第一个字节。</p><p>Time to First Byte(TTFB)是用户通过点击链接进行请求与收到第一个HTML包之间的时间。</p><p>第一个响应包是<strong>14kb</strong>大小。这是<strong>慢开始</strong>的一部分，慢开始是一种均衡网络连接速度的算法。慢开始逐渐增加发送数据的数量直到达到网络的最大带宽。</p><p>在”TCP slow start”中，在收到初始包之后, 服务器会将下一个包的大小加倍到大约28kb。 后续的包依次是前一个包大小的二倍直到达到预定的阈值，或者遇到拥塞。</p><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/bt3nG6"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s4.ax1x.com/2022/03/03/bt3nG6.jpg" alt="bt3nG6.jpg"></a></p><p>如果您听说过初始页面加载的14Kb规则，TCP慢开始就是初始响应为14Kb的原因，也是为什么web性能优化需要将此初始14Kb响应作为优化重点的原因。TCP慢开始逐渐建立适合网络能力的传输速度，以避免拥塞。</p><p>当服务器用TCP包来发送数据时，客户端通过返回确认帧来确认传输。由于硬件和网络条件，连接的容量是有限的。 如果服务器太快地发送太多的包，它们可能会被丢弃。意味着，将不会有确认帧的返回。服务器把它们当做确认帧丢失。拥塞控制算法使用这个发送包和确认帧流来确定发送速率。</p><h3 id="IP"><a href="#IP" class="headerlink" title="IP"></a>IP</h3><p>TCP模块在执行<strong>连接</strong>、<strong>收发</strong>、<strong>断开</strong>等各阶段操作时，都需要<strong>委托IP模块将数据封装成网络包发送给通信对象</strong>。</p><p>在IP协议里面需要有<strong>源地址IP</strong>和<strong>目标地址IP</strong>:</p><ul><li>源地址IP，即是客户端输出的IP地址;</li><li>目标地址，即通过DNS域名解析得到的Web服务器IP。</li></ul><p>因为HTTP是经过TCP传输的，所以在IP包头的协议号，要填写为06(十六进制)，表示协议为TCP。</p><p><strong>MAC</strong></p><p>生成了IP头部之后，接下来网络包还需要在IP头部的前面加上<strong>MAC头部</strong>。</p><p>MAC头部是以太网使用的头部，它包含了接收方和发送方的<strong>MAC地址</strong>等信息。</p><p>在MAC包头里需要发送方MAC地址和接收方目标MAC地址，用于两点之间的传输。</p><h2 id="网卡"><a href="#网卡" class="headerlink" title="网卡"></a>网卡</h2><p>网络包只是存放在内存中的一串二进制数字信息，没有办法直接发送给对方。因此，我们需要将<strong>数字信息转换为电信号</strong>，才能在网线上传输，也就是说，这才是真正的数据发送过程。</p><p>负责执行这一操作的是网卡，要控制网卡还需要靠网卡驱动程序。</p><p><strong>网卡驱动从IP模块获取到包之后，会将其复制到网卡内的缓存区中，接着会在其开头加上报头和起始帧分界符，在末尾加上用于检测错误的帧校验序列。</strong></p><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/btQlrj"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s4.ax1x.com/2022/03/03/btQlrj.png" alt="btQlrj.png"></a></p><ul><li>起始帧分界符是一个用来表示包起始位置的标记</li><li>末尾的FCS(帧校验序列)用来检查包传输过程是否有损坏</li></ul><p>最后<strong>网卡会将包转为电信号，通过网线发送出去</strong>。</p><h2 id="交换机"><a href="#交换机" class="headerlink" title="交换机"></a>交换机</h2><p>交换机的设计是将网络包原样转发到目的地。交换机工作在<strong>MAC层</strong>，也称为二层网络设备。</p><p><strong>交换机根据MAC地址表查找 MAC地址，然后将信号发送到相应的端口。</strong></p><h2 id="路由器"><a href="#路由器" class="headerlink" title="路由器"></a>路由器</h2><p>网络包经过交换机之后，现在到达了路由器，并在此被转发到下一个路由器或目标设备。</p><p>这一步转发的工作原理和交换机类似，也是通过查表判断包转发的目标。</p><p>不过在具体的操作过程上，路由器和交换机是有区别的。</p><ul><li>因为<strong>路由器是基于IP设计</strong>的，俗称三层网络设备，路由器的各个<strong>端口</strong>都具有<strong>MAC地址</strong>和<strong>IP地址</strong>;</li><li>而<strong>交换机是基于以太网设计</strong>的，俗称二层网络设备，交换机的端口<strong>不具有MAC地址</strong>。</li></ul><p>路由器的端口具有MAC地址，因此它就能够成为以太网的发送方和接收方；</p><p>同时还具有IP地址，从这个意义上来说，它和计算机的网卡是一样的。</p><p>当转发包时，首先路由器端口会接收发给自己的以太网包，然后路由表查询转发目标，再由相应的端口作为发送方将以太网包发送出去。</p><h2 id="服务器处理请求并返回-HTTP-报文"><a href="#服务器处理请求并返回-HTTP-报文" class="headerlink" title="服务器处理请求并返回 HTTP 报文"></a>服务器处理请求并返回 HTTP 报文</h2><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/btlOtx"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s4.ax1x.com/2022/03/03/btlOtx.png" alt="btlOtx.png"></a></p><p>数据包抵达服务器后，服务器会先扒开数据包的<strong>MAC头部</strong>，查看是否和服务器自己的MAC地址符合，符合就将包收起来。</p><p>接着继续扒开数据包的<strong>IP头</strong>，发现IP地址符合，根据IP头中协议项，知道自己上层是<strong>TCP协议</strong>。</p><p>于是，扒开TCP的头，里面有<strong>序列号</strong>，需要看一看这个序列包是不是我想要的，如果是就放入缓存中然后返回一个<strong>ACK</strong>，如果不是就丢弃。TCP头部里面还有<strong>端口号</strong>，HTTP的服务器正在监听这个端口号。</p><p>于是，服务器自然就知道是HTTP进程想要这个包，于是就将包发给<strong>HTTP进程</strong>。</p><p>服务器的HTTP进程看到，原来这个请求是要访问一个页面，于是就把这个网页封装在HTTP响应报文里。</p><p>HTTP响应报文也需要穿上TCP、IP、MAC头部，不过这次是源地址是服务器IP地址，目的地址是客户端P地址。</p><h2 id="浏览器解析渲染页面"><a href="#浏览器解析渲染页面" class="headerlink" title="浏览器解析渲染页面"></a>浏览器解析渲染页面</h2><p>浏览器拿到HTTP响应报文后，接下来介绍下浏览器渲染机制</p><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/5J63Rg"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://z3.ax1x.com/2021/10/16/5J63Rg.png" alt="5J63Rg.png"></a></p><p>浏览器解析渲染页面分为一下五个步骤：</p><ul><li>根据 HTML 解析出 DOM 树</li><li>根据 CSS 解析生成 CSS 规则树（<strong>CSSOM</strong>）</li><li>结合 DOM 树和 CSS 规则树，生成渲染树</li><li>根据渲染树计算每一个节点的信息</li><li>根据计算好的信息绘制页面</li></ul><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/btNIeO"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s4.ax1x.com/2022/03/03/btNIeO.png" alt="btNIeO.png"></a></p><h3 id="根据-HTML-解析出-DOM-树"><a href="#根据-HTML-解析出-DOM-树" class="headerlink" title="根据 HTML 解析出 DOM 树"></a>根据 HTML 解析出 DOM 树</h3><p>第一步是处理HTML标记并构造DOM树。HTML解析涉及到<strong>标记化</strong>和<strong>树的构造</strong>。</p><p>HTML标记包括开始和结束标记，以及属性名和值。</p><p>如果文档格式良好，则解析它会简单而快速。解析器将标记化的输入解析到文档中，构建DOM树。</p><p>DOM树描述了文档的内容。<code>&lt;html&gt;</code>元素是第一个标签也是文档树的根节点。</p><p>树反映了不同标记之间的关系和层次结构。嵌套在其他标记中的标记是子节点。</p><p>DOM节点的数量越多，构建DOM树所需的时间就越长。</p><p>当解析器发现非阻塞资源，例如一张<strong>图片</strong>，浏览器会请求这些资源并且继续解析。</p><p>当遇到一个<strong>CSS</strong>文件时，解析也可以继续进行。</p><p>但是对于<code>&lt;script&gt;</code>标签（特别是没有 <code>async</code> 或者 <code>defer</code> 属性）会<strong>阻塞渲染并停止HTML的解析</strong>。</p><p>尽管浏览器的预加载扫描器加速了这个过程，但过多的脚本仍然是一个重要的瓶颈。</p><p>浏览器构建DOM树时，这个过程占用了<strong>主线程</strong>。</p><p>当这种情况发生时，<strong>预加载</strong>扫描仪将解析可用的内容并请求高优先级资源，如CSS、JavaScript和web字体。</p><p>多亏了预加载扫描器，我们不必等到解析器找到对外部资源的引用来请求它。</p><p>它将<strong>在后台检索资源，以便在主HTML解析器到达请求的资源时，它们可能已经在运行，或者已经被下载</strong>。</p><p>预加载扫描仪提供的优化<strong>减少了阻塞</strong>。</p><h3 id="根据-CSS-解析生成-CSS-规则树（CSSOM）"><a href="#根据-CSS-解析生成-CSS-规则树（CSSOM）" class="headerlink" title="根据 CSS 解析生成 CSS 规则树（CSSOM）"></a>根据 CSS 解析生成 CSS 规则树（CSSOM）</h3><p>第二步是处理CSS并构建CSSOM树。CSS对象模型和DOM是相似的。</p><p><strong>DOM和CSSOM是两棵树. 它们是独立的数据结构。</strong></p><p>浏览器将CSS规则转换为可以理解和使用的样式映射。</p><p>浏览器遍历CSS中的每个规则集，根据CSS选择器创建具有父、子和兄弟关系的节点树。</p><p>与HTML一样，浏览器需要将接收到的CSS规则转换为可以使用的内容。因此，它重复了HTML到对象的过程，但这是对于CSS的。</p><p>CSSOM树包括来自用户代理样式表的样式。</p><p>浏览器从适用于节点的最通用规则开始，并通过应用更具体的规则递归地优化计算的样式。换句话说，它级联属性值。</p><p>构建CSSOM非常非常快，并且在当前的开发工具中没有以独特的颜色显示。</p><p>相反，开发人员工具中的“重新计算样式”显示解析CSS、构造CSSOM树和递归计算计算样式所需的总时间。</p><p>在web性能优化方面，它是可轻易实现的，因为创建CSSOM的总时间通常小于一次DNS查找所需的时间。</p><h3 id="JavaScript-编译"><a href="#JavaScript-编译" class="headerlink" title="JavaScript 编译"></a>JavaScript 编译</h3><p>当CSS被解析并创建CSSOM时，其他资源，包括JavaScript文件正在下载（多亏了preload scanner）。JavaScript被解释、编译、解析和执行。脚本被解析为抽象语法树。</p><h3 id="渲染"><a href="#渲染" class="headerlink" title="渲染"></a>渲染</h3><p>渲染步骤包括<strong>样式</strong>、<strong>布局</strong>、绘制，在某些情况下还包括合成。</p><p>在解析步骤中创建的<strong>CSSOM树和DOM树组合成一个Render树</strong>，然后用于计算每个可见元素的布局，然后将其绘制到屏幕上。</p><p>在某些情况下，可以将内容提升到它们自己的层并进行合成，通过在GPU而不是CPU上绘制屏幕的一部分来提高性能，从而释放主线程。</p><h4 id="Style"><a href="#Style" class="headerlink" title="Style"></a>Style</h4><p>第三步是将DOM和CSSOM组合成一个Render树，计算样式树或渲染树从DOM树的根开始构建，遍历每个可见节点。</p><p>像<code>&lt;head&gt;</code>和它的<strong>子节点</strong>以及任何具有<code>display: none</code>样式的结点，例如<code>script &#123; display: none; &#125;</code>这些标签将<strong>不会显示</strong>，也就是它们不会出现在Render树上。</p><p>具有<code>visibility: hidden</code>的节点<strong>会出现在Render树上，因为它们会占用空间</strong>。</p><p>每个可见节点都应用了其CSSOM规则。</p><p>Render树保存所有具有内容和计算样式的可见节点——<strong>将所有相关样式匹配到DOM树中的每个可见节点，并根据CSS级联确定每个节点的计算样式。</strong></p><h4 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a>Layout</h4><p>第四步是<strong>在渲染树上运行布局以计算每个节点的几何体</strong>。</p><p>布局是确定呈现树中所有节点的宽度、高度和位置，以及确定页面上每个对象的大小和位置的过程。</p><p><strong>回流是对页面的任何部分或整个文档的任何后续大小和位置的确定。</strong></p><p>构建渲染树后，开始布局。渲染树标识显示哪些节点（即使不可见）及其计算样式，但不标识每个节点的尺寸或位置。</p><p>为了确定每个对象的确切大小和位置，浏览器从渲染树的根开始遍历它。</p><p>在网页上，大多数东西都是一个盒子。不同的设备和不同的桌面意味着无限数量的不同的视区大小。</p><p>在此阶段，考虑到视区大小，浏览器将确定屏幕上所有不同框的尺寸。</p><p><strong>以视区的大小为基础</strong>，布局通常从body开始，用每个元素的框模型属性排列所有body的子孙元素的尺寸，为不知道其尺寸的替换元素（例如图像）提供占位符空间。</p><p><strong>第一次确定节点的大小和位置称为布局。</strong></p><p><strong>随后对节点大小和位置的重新计算称为回流。</strong></p><p>在我们的示例中，<strong>假设初始布局发生在返回图像之前。由于我们没有声明图像的大小，因此一旦知道图像大小，就会有回流。</strong></p><h4 id="Paint"><a href="#Paint" class="headerlink" title="Paint"></a>Paint</h4><p>最后一步是将各个节点绘制到屏幕上，第一次出现的节点称为<strong>首次有意义的绘制</strong>(FMP) 。</p><p>在绘制或光栅化阶段，浏览器将在布局阶段计算的每个框转换为屏幕上的实际像素。</p><p>绘画包括将元素的每个可视部分绘制到屏幕上，包括<strong>文本、颜色、边框、阴影和替换的元素（如按钮和图像）</strong>。</p><p>浏览器需要非常快地完成这项工作。</p><p>为了确保平滑滚动和动画，占据主线程的所有内容，包括计算样式，以及回流和绘制，必须让浏览器在16.67毫秒内完成。</p><p>在2048x 1536，iPad有超过314.5万像素将被绘制到屏幕上。那是很多像素需要快速绘制。</p><p><strong>为了确保重绘的速度比初始绘制的速度更快，屏幕上的绘图通常被分解成数层。如果发生这种情况，则需要进行合成。</strong></p><p>绘制可以将布局树中的元素分解为多个层。将内容提升到GPU上的层（而不是CPU上的主线程）可以提高绘制和重新绘制性能。</p><p><strong>有一些特定的属性和元素可以实例化一个层</strong>，包括<code>&lt;video&gt;</code>和<code>&lt;canvas&gt;</code>，任何CSS属性为<code>opacity</code>、3D <code>transform</code>, <code>will-change</code>的元素，还有一些其他元素。</p><p>这些节点将与子节点一起绘制到它们自己的层上，除非子节点由于上述一个（或多个）原因需要自己的层。</p><p>分层确实可以提高性能，但是它以<strong>内存管理</strong>为代价，因此不应作为web性能优化策略的一部分过度使用。</p><h4 id="Compositing"><a href="#Compositing" class="headerlink" title="Compositing"></a>Compositing</h4><p>当文档的各个部分以不同的层绘制，相互重叠时，必须进行<strong>合成</strong>，以确保它们以正确的顺序绘制到屏幕上，并正确显示内容。</p><p>当页面继续加载资产时，可能会发生回流（回想一下我们迟到的示例图像），<strong>回流会触发重新绘制和重新组合</strong>。</p><p>如果我们定义了图像的大小，就不需要重新绘制，只需要重新绘制需要重新绘制的层，并在必要时进行合成。</p><p>但<strong>我们没有定义图像大小！从服务器获取图像后，渲染过程将返回到布局步骤并从那里重新开始。</strong></p><h3 id="交互"><a href="#交互" class="headerlink" title="交互"></a>交互</h3><p>一旦主线程绘制页面完成，你会认为我们已经“准备好了”，但事实并非如此。</p><p>如果加载包含JavaScript（并且延迟到<code>onload</code>事件激发后执行），则<strong>主线程可能很忙</strong>，无法用于滚动、触摸和其他交互。</p><p>”Time to Interactive“（TTI）是测量从第一个请求导致DNS查找和SSL连接到页面<strong>可交互</strong>时所用的时间——可交互是”First Contentful Paint“之后的时间点，页面在50ms内响应用户的交互。</p><p><strong>如果主线程正在解析、编译和执行JavaScript，则它不可用，因此无法及时（小于50ms）响应用户交互。</strong></p><p>在我们的示例中，可能图像加载很快，但<code>anotherscript.js</code>文件可能是2MB，而且用户的网络连接很慢。</p><p>在这种情况下，用户可以非常快地看到页面，但是在下载、解析和执行脚本之前，就无法滚动。这不是一个好的用户体验。</p><h2 id="断开TCP连接-四次挥手"><a href="#断开TCP连接-四次挥手" class="headerlink" title="断开TCP连接 四次挥手"></a>断开TCP连接 四次挥手</h2><p><strong>双方都可以主动断开连接，断开连接后主机中的「资源」将被释放。</strong></p><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/btNzm8"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s4.ax1x.com/2022/03/03/btNzm8.png" alt="btNzm8.png"></a></p><ul><li>客户端打算关闭连接，此时会发送一个TCP首部<code>FIN</code> 标志位被置为<code>1</code>的报文，也即<code>FIN</code> 报文，之后客户端进入<code>FIN_WAIT_1</code>状态。</li><li>服务端收到该报文后，就向客户端发送<code>ACK</code>应答报文，接着服务端进入<code>CLOSED_WAIT</code>状态。</li><li>客户端收到服务端的<code>ACK</code>应答报文后，之后进入<code>FIN_WAIT_2</code>状态。</li><li>等待<strong>服务端处理完数据后</strong>，也向客户端发送<code>FIN</code> 报文，之后服务端进入<code>LAST_ACK</code>状态。</li><li>客户端收到服务端的<code>FIN</code> 报文后，回一个<code>ACK</code>应答报文，之后进入<code>TIME_WAIT</code>状态。</li><li>服务器收到了<code>ACK</code>应答报文后，就进入了<code>CLOSED</code>状态，至此<strong>服务端已经完成连接的关闭</strong>。</li><li>客户端在经过<code>2MSL</code>一段时间后，自动进入<code>CLOSED</code>状态，至此<strong>客户端也完成连接的关闭</strong>。</li></ul><p>你可以看到，每个方向都需要一个<code>FIN</code>和一个<code>ACK</code>，因此通常被称为<strong>四次挥手</strong>。</p><p>这里一点需要注意是∶<strong>主动关闭连接的，才有TIME_WAIT状态</strong>。</p><h3 id="为什么挥手需要四次"><a href="#为什么挥手需要四次" class="headerlink" title="为什么挥手需要四次?"></a>为什么挥手需要四次?</h3><p>再来回顾下四次挥手双方发FIN 包的过程，就能理解为什么需要四次了。</p><ul><li>关闭连接时，客户端向服务端发送<code>FIN</code> 时，仅仅表示<strong>客户端不再发送数据了但是还能接收数据</strong>。</li><li>服务器收到客户端的<code>FIN</code>报文时，先回一个<code>ACK</code>应答报文，而服务端可能还有数据需要处理和发送，等<br>服务端不再发送数据时，才发送<code>FIN</code>报文给客户端来表示同意现在关闭连接。</li></ul><p>从上面过程可知，<strong>服务端通常需要等待完成数据的发送和处理</strong>，所以服务端的<code>ACK</code>和 <code>FIN</code>一般都会分开发送，从而比三次握手导致多了一次。</p><h3 id="为什么TIME-WAIT等待的时间是2MSL"><a href="#为什么TIME-WAIT等待的时间是2MSL" class="headerlink" title="为什么TIME_WAIT等待的时间是2MSL?"></a>为什么TIME_WAIT等待的时间是2MSL?</h3><p><code>MSL</code>是<code>Maximum Segment Lifetime</code>，报文最大生存时间，它是任何报文在网络上存在的最长时间，超过这个时间报文将被丢弃。因为TCP报文基于是IP协议的，而IP头中有一个<code>TTL</code>字段，是IP数据报可以经过的最大路由数，每经过一个处理他的路由器此值就减1，当此值为0则数据报将被丢弃，同时发送<code>ICMP</code>报文通知源主机。</p><p><code>MSL</code>与<code>TTL</code>的区别:</p><p>MSL的单位是时间，而TTL是经过路由跳数。所以 MSL应该要大于等于TTL消耗为0的时间，以确保报文已被自然消亡。</p><p><code>TIME_WAIT</code> 等待<strong>2倍的MSL</strong>，比较合理的解释是︰网络中可能存在<strong>来自发送方的数据包</strong>,当这些发送方的数据包被接收方处理后又会向对方发送响应，所以一来一回需要等待⒉倍的时间。</p><p>如果被动关闭方没有收到断开连接的最后的ACK报文，就会触发超时重发Fin 报文，另一方接收到FIN后，会重发ACK给被动关闭方，—来一去正好2个MSL。</p><p>2MSL 的时间是<strong>从客户端接收到FIN后发送 ACK开始计时的</strong>。如果在TIME-WAIT时间内，因为客户端的ACK没有传输到服务端，客户端又接收到了服务端重发的FIN 报文，那么2MSL时间将重新计时。</p><h3 id="为什么需要TIME-WAIT状态"><a href="#为什么需要TIME-WAIT状态" class="headerlink" title="为什么需要TIME_WAIT状态?"></a>为什么需要TIME_WAIT状态?</h3><p>主动发起关闭连接的一方，才会有<code>TIME-WAIT</code>状态。</p><p>需要TIME-WAIT状态，主要是两个原因︰</p><ul><li>防止具有相同「四元组」的「旧」数据包被收到;</li><li>保证「被动关闭连接」的一方能被正确的关闭，即<strong>保证最后的ACK能让被动关闭方接收，从而帮助其正常关闭;</strong></li></ul><p>经过<code>2MSL</code>这个时间，<strong>足以让两个方向上的数据包都被丢弃，使得原来连接的数据包在网络中都自然消失，再出现的数据包一定都是新建立连接所产生的。</strong></p><p><code>TIME-WAIT</code>更重要的作用是<strong>等待足够的时间以确保最后的ACK能让被动关闭方接收，从而帮助其正常关闭</strong>。</p><h2 id="性能优化之回流重绘"><a href="#性能优化之回流重绘" class="headerlink" title="性能优化之回流重绘"></a>性能优化之回流重绘</h2><h3 id="回流-重排reflow"><a href="#回流-重排reflow" class="headerlink" title="回流/重排reflow"></a>回流/重排reflow</h3><p><strong>当Render Tree中部分或全部元素的尺寸、结构、或某些属性发生改变时，浏览器重新渲染部分或全部文档的过程</strong>。</p><h3 id="重绘Repaint"><a href="#重绘Repaint" class="headerlink" title="重绘Repaint"></a>重绘Repaint</h3><p><strong>当页面中元素样式的改变并不影响它在文档流中的位置时（例如：color、background-color、visibility等），浏览器会将新样式赋予给元素并重新绘制它</strong>。</p><p>根据 Opera 的说法，重绘成本很高，<strong>因为浏览器必须验证 DOM 树中所有其他节点的可见性</strong>。</p><p>回流对性能甚至更为关键，因为它涉及<strong>影响页面一部分（或整个页面）布局的更</strong>改。元素的重排会导致所有子元素和祖先元素以及 DOM 中跟随它的任何元素的后续<strong>回流</strong>。回流在性能方面非常昂贵，并且是导致 DOM 脚本缓慢的主要原因之一，尤其是在处理能力较低的设备上，例如手机。在很多情况下，它们相当于重新布局整个页面。</p><p>不幸的是，很多事情都会引发回流。其中一些在编写 CSS 时特别相关：</p><ul><li>调整窗口大小</li><li>更改字体</li><li>添加或删除样式表</li><li>内容更改，例如用户在输入框中键入文本</li><li>激活 CSS 伪类，例如 :hover（在 IE 中激活兄弟的伪类）</li><li>操作类属性</li><li>操作 DOM 的脚本</li><li>计算offsetWidth 和 offsetHeight</li><li>设置样式属性的属性</li></ul><h3 id="如何避免回流或至少最小化它们对性能的影响？"><a href="#如何避免回流或至少最小化它们对性能的影响？" class="headerlink" title="如何避免回流或至少最小化它们对性能的影响？"></a>如何避免回流或至少最小化它们对性能的影响？</h3><h4 id="在-dom-树中尽可能低地更改类"><a href="#在-dom-树中尽可能低地更改类" class="headerlink" title="在 dom 树中尽可能低地更改类"></a>在 dom 树中尽可能低地更改类</h4><p>当回流信息传递到周围节点时，回流可以是自上而下或自下而上的。回流是不可避免的，但您可以减少它们的影响。在 dom 树中尽可能低地更改类，从而将回流的范围限制在尽可能少的节点上。例如，您应该避免更改包装元素上的类以影响子节点的显示。面向对象的 css 总是尝试将类附加到它们影响的对象（DOM 节点或节点），但在这种情况下，它具有最小化回流影响的额外性能优势。</p><h4 id="避免设置多个内联样式"><a href="#避免设置多个内联样式" class="headerlink" title="避免设置多个内联样式"></a>避免设置多个内联样式</h4><p>我们都知道与 DOM 交互很慢。我们尝试将更改分组到一个不可见的 DOM 树片段中，然后当整个更改应用于 DOM 时仅导致一次重排。同样，通过 style 属性设置样式会导致重排。避免设置多个内联样式，每个样式都会导致重排，样式应该组合在一个外部类中，当操作元素的类属性时，只会导致一个重排。</p><h4 id="应用动画到fixed或absolute的定位"><a href="#应用动画到fixed或absolute的定位" class="headerlink" title="应用动画到fixed或absolute的定位"></a>应用动画到fixed或absolute的定位</h4><p>将动画应用于fixed或absolute的定位元素。它们不会影响其他元素的布局，因此它们<strong>只会导致重绘而不是完全回流</strong>。这成本要低得多。</p><h4 id="以平滑换取速度"><a href="#以平滑换取速度" class="headerlink" title="以平滑换取速度"></a>以平滑换取速度</h4><p>Opera 还建议我们以平滑换取速度。他们的意思是，您可能希望一次将动画移动 1 个像素，但如果动画和随后的回流使用 100% 的 CPU，则动画会看起来很跳跃，因为浏览器难以更新流程。一次将动画元素移动 3 个像素在速度非常快的机器上可能看起来不太流畅，但在速度较慢的机器和移动设备上不会导致 CPU 抖动。</p><h4 id="避免使用表格进行布局（或设置表格布局固定）"><a href="#避免使用表格进行布局（或设置表格布局固定）" class="headerlink" title="避免使用表格进行布局（或设置表格布局固定）"></a>避免使用表格进行布局（或设置表格布局固定）</h4><p>避免使用表格进行布局。好像您需要另一个理由来避免它们一样，<strong>表格通常需要多次传递才能完全建立布局</strong>，因为它们是元素会影响 DOM 上出现在它们之前的其他元素的显示的罕见情况之一。想象一下表格末尾的一个单元格，其内容非常宽，导致列完全调整大小。这就是为什么表格不是在所有浏览器中逐步呈现的原因，这也是为什么它们不适合布局的另一个原因。根据 Mozilla 的说法，<strong>即使是很小的更改也会导致表中所有其他节点的回流。</strong></p><p>YUI 数据表小部件的所有者 Jenny Donnelly 建议<strong>对数据表使用固定布局</strong>，以实现更高效的布局算法。除“auto”之外的任何 table-layout 值都将触发固定布局并允许表格根据 CSS 2.1 规范逐行呈现。Quirksmode 表明浏览器对 table-layout 属性的支持在所有主要浏览器中都很好。</p><blockquote><p>以这种方式，一旦接收到整个第一行，用户代理就可以开始布置表格。后续行中的单元格不影响列宽。任何具有溢出内容的单元格都使用“溢出”属性来确定是否剪切溢出内容。</p></blockquote><blockquote><p>该算法可能效率低下，因为它要求用户代理在确定最终布局之前可以访问表中的所有内容，并且可能需要不止一次通过。</p></blockquote><h4 id="避免在-CSS-中使用JavaScript-表达式"><a href="#避免在-CSS-中使用JavaScript-表达式" class="headerlink" title="避免在 CSS 中使用JavaScript 表达式"></a>避免在 CSS 中使用JavaScript 表达式</h4><p>这条规则很老套，但很好。<strong>这些表达式如此昂贵</strong>的主要原因是因为每次文档或文档的一部分重排时都会重新计算它们。正如我们从触发回流的所有许多事情中看到的那样，它每秒可能发生数千次。</p><p>可能指CSS表达式？（例如：<code>calc()</code>）</p><h4 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h4><ul><li><strong>避免频繁操作样式</strong>，最好一次性重写style属性，或者将样式列表定义为class并一次性更改class属性。</li><li><strong>避免频繁操作DOM</strong>。</li><li>也可以先为元素设置<code>display: none</code>，操作结束后再把它显示出来。因为在display属性为none的元素上进行的DOM操作不会引发回流和重绘。</li><li><strong>避免频繁读取会引发回流/重绘的属性</strong>，如果确实需要多次使用，就用一个变量缓存起来。</li><li>对具有复杂动画的元素使用<strong>绝对定位</strong>，使它脱离文档流，否则会引起父元素及后续元素频繁回流。</li></ul><h4 id="React的虚拟DOM"><a href="#React的虚拟DOM" class="headerlink" title="React的虚拟DOM"></a>React的虚拟DOM</h4><p>React的虚拟DOM的作用是将真实 DOM 的副本存储在内存中。当您修改 DOM 时，它首先将这些更改应用到内存中的 DOM。然后，使用它的差异算法，找出真正发生了什么变化。最后，它对更改进行批处理，并调用一次将它们应用到 real-dom 上。因此，<strong>最大限度地减少了回流和重绘。</strong></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Leslie Waong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lesliewaong.top/posts/6154ca16.html">https://lesliewaong.top/posts/6154ca16.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lesliewaong.top" target="_blank">Leslie Waong</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/HTTP/">HTTP</a><a class="post-meta__tags" href="/tags/TCP/">TCP</a><a class="post-meta__tags" href="/tags/DNS/">DNS</a><a class="post-meta__tags" href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93/">浏览器渲染</a><a class="post-meta__tags" href="/tags/%E5%9B%9E%E6%B5%81%E9%87%8D%E7%BB%98/">回流重绘</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/1.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/wx.png" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/wx.png" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/zfb.png" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/zfb.png" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/58c5541d.html"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/13.jpg" onerror='onerror=null,src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/friend_404.gif"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">跨域通信</div></div></a></div><div class="next-post pull-right"><a href="/posts/2c5b9cd5.html"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/6.jpg" onerror='onerror=null,src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/friend_404.gif"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">HTTP相关内容</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/2c5b9cd5.html" title="HTTP相关内容"><img class="cover" src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/6.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-02</div><div class="title">HTTP相关内容</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/avatar.jpg" onerror='this.onerror=null,this.src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">Leslie Waong</div><div class="author-info__description">BUPT</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">104</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lesliewaong"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Lesliewaong" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=1138964397&amp;website=www.qtxml.cn" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">红雨漂泊泛起了回忆怎么潜</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8EURL%E8%BE%93%E5%85%A5%E5%88%B0%E9%A1%B5%E9%9D%A2%E5%B1%95%E7%8E%B0%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">从URL输入到页面展现到底发生什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#URL%E8%A7%A3%E6%9E%90%E5%B9%B6%E7%94%9F%E6%88%90HTTP%E8%AF%B7%E6%B1%82%E6%B6%88%E6%81%AF"><span class="toc-text">URL解析并生成HTTP请求消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#URL%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">URL是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90HTTP%E8%AF%B7%E6%B1%82%E6%B6%88%E6%81%AF"><span class="toc-text">生成HTTP请求消息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%EF%BC%88DNS%EF%BC%89"><span class="toc-text">域名解析（DNS）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E7%9A%84%E5%B1%82%E7%BA%A7%E5%85%B3%E7%B3%BB"><span class="toc-text">域名的层级关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IP-%E5%9C%B0%E5%9D%80"><span class="toc-text">IP 地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90"><span class="toc-text">什么是域名解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87%E5%9F%9F%E5%90%8D%E5%8E%BB%E6%9F%A5%E8%AF%A2-URL-%E5%AF%B9%E5%BA%94%E7%9A%84-IP-%E5%91%A2"><span class="toc-text">浏览器如何通过域名去查询 URL 对应的 IP 呢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">DNS负载均衡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8F%E8%AE%AE%E6%A0%88"><span class="toc-text">协议栈</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B"><span class="toc-text">TCP三次握手</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP"><span class="toc-text">TCP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B"><span class="toc-text">三次握手</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B-%E4%B8%8D%E6%98%AF%E4%B8%A4%E6%AC%A1%E3%80%81%E5%9B%9B%E6%AC%A1"><span class="toc-text">为什么是三次握手?不是两次、四次?</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E5%8E%86%E5%8F%B2%E8%BF%9E%E6%8E%A5"><span class="toc-text">避免历史连接</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%8F%8C%E6%96%B9%E5%88%9D%E5%A7%8B%E5%BA%8F%E5%88%97%E5%8F%B7"><span class="toc-text">同步双方初始序列号</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E8%B5%84%E6%BA%90%E6%B5%AA%E8%B4%B9"><span class="toc-text">避免资源浪费</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP%E5%88%86%E5%89%B2%E6%95%B0%E6%8D%AE"><span class="toc-text">TCP分割数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP%E6%8A%A5%E6%96%87%E7%94%9F%E6%88%90"><span class="toc-text">TCP报文生成</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TLS-%E5%8D%8F%E5%95%86"><span class="toc-text">TLS 协商</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP%E6%85%A2%E5%BC%80%E5%A7%8B%E5%92%8C%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6"><span class="toc-text">TCP慢开始和拥塞控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IP"><span class="toc-text">IP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E5%8D%A1"><span class="toc-text">网卡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-text">交换机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%99%A8"><span class="toc-text">路由器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E5%B9%B6%E8%BF%94%E5%9B%9E-HTTP-%E6%8A%A5%E6%96%87"><span class="toc-text">服务器处理请求并返回 HTTP 报文</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%A7%A3%E6%9E%90%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2"><span class="toc-text">浏览器解析渲染页面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE-HTML-%E8%A7%A3%E6%9E%90%E5%87%BA-DOM-%E6%A0%91"><span class="toc-text">根据 HTML 解析出 DOM 树</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE-CSS-%E8%A7%A3%E6%9E%90%E7%94%9F%E6%88%90-CSS-%E8%A7%84%E5%88%99%E6%A0%91%EF%BC%88CSSOM%EF%BC%89"><span class="toc-text">根据 CSS 解析生成 CSS 规则树（CSSOM）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JavaScript-%E7%BC%96%E8%AF%91"><span class="toc-text">JavaScript 编译</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93"><span class="toc-text">渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Style"><span class="toc-text">Style</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Layout"><span class="toc-text">Layout</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Paint"><span class="toc-text">Paint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Compositing"><span class="toc-text">Compositing</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E4%BA%92"><span class="toc-text">交互</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%AD%E5%BC%80TCP%E8%BF%9E%E6%8E%A5-%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B"><span class="toc-text">断开TCP连接 四次挥手</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%8C%A5%E6%89%8B%E9%9C%80%E8%A6%81%E5%9B%9B%E6%AC%A1"><span class="toc-text">为什么挥手需要四次?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88TIME-WAIT%E7%AD%89%E5%BE%85%E7%9A%84%E6%97%B6%E9%97%B4%E6%98%AF2MSL"><span class="toc-text">为什么TIME_WAIT等待的时间是2MSL?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81TIME-WAIT%E7%8A%B6%E6%80%81"><span class="toc-text">为什么需要TIME_WAIT状态?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B9%8B%E5%9B%9E%E6%B5%81%E9%87%8D%E7%BB%98"><span class="toc-text">性能优化之回流重绘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E6%B5%81-%E9%87%8D%E6%8E%92reflow"><span class="toc-text">回流&#x2F;重排reflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E7%BB%98Repaint"><span class="toc-text">重绘Repaint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E5%9B%9E%E6%B5%81%E6%88%96%E8%87%B3%E5%B0%91%E6%9C%80%E5%B0%8F%E5%8C%96%E5%AE%83%E4%BB%AC%E5%AF%B9%E6%80%A7%E8%83%BD%E7%9A%84%E5%BD%B1%E5%93%8D%EF%BC%9F"><span class="toc-text">如何避免回流或至少最小化它们对性能的影响？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8-dom-%E6%A0%91%E4%B8%AD%E5%B0%BD%E5%8F%AF%E8%83%BD%E4%BD%8E%E5%9C%B0%E6%9B%B4%E6%94%B9%E7%B1%BB"><span class="toc-text">在 dom 树中尽可能低地更改类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E8%AE%BE%E7%BD%AE%E5%A4%9A%E4%B8%AA%E5%86%85%E8%81%94%E6%A0%B7%E5%BC%8F"><span class="toc-text">避免设置多个内联样式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%8A%A8%E7%94%BB%E5%88%B0fixed%E6%88%96absolute%E7%9A%84%E5%AE%9A%E4%BD%8D"><span class="toc-text">应用动画到fixed或absolute的定位</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A5%E5%B9%B3%E6%BB%91%E6%8D%A2%E5%8F%96%E9%80%9F%E5%BA%A6"><span class="toc-text">以平滑换取速度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8%E8%A1%A8%E6%A0%BC%E8%BF%9B%E8%A1%8C%E5%B8%83%E5%B1%80%EF%BC%88%E6%88%96%E8%AE%BE%E7%BD%AE%E8%A1%A8%E6%A0%BC%E5%B8%83%E5%B1%80%E5%9B%BA%E5%AE%9A%EF%BC%89"><span class="toc-text">避免使用表格进行布局（或设置表格布局固定）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E5%9C%A8-CSS-%E4%B8%AD%E4%BD%BF%E7%94%A8JavaScript-%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-text">避免在 CSS 中使用JavaScript 表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JavaScript"><span class="toc-text">JavaScript</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#React%E7%9A%84%E8%99%9A%E6%8B%9FDOM"><span class="toc-text">React的虚拟DOM</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/28d62aa4.html" title="居中布局与Flex"><img src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/5.jpg" onerror='this.onerror=null,this.src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/friend_404.gif"' alt="居中布局与Flex"></a><div class="content"><a class="title" href="/posts/28d62aa4.html" title="居中布局与Flex">居中布局与Flex</a><time datetime="2022-04-02T10:14:52.000Z" title="发表于 2022-04-02 18:14:52">2022-04-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/24025dd2.html" title="原型和继承"><img src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/1.jpg" onerror='this.onerror=null,this.src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/friend_404.gif"' alt="原型和继承"></a><div class="content"><a class="title" href="/posts/24025dd2.html" title="原型和继承">原型和继承</a><time datetime="2022-04-01T11:12:22.000Z" title="发表于 2022-04-01 19:12:22">2022-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/9a4e49b6.html" title="let、const和var的区别"><img src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/1.webp" onerror='this.onerror=null,this.src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/friend_404.gif"' alt="let、const和var的区别"></a><div class="content"><a class="title" href="/posts/9a4e49b6.html" title="let、const和var的区别">let、const和var的区别</a><time datetime="2022-04-01T04:22:32.000Z" title="发表于 2022-04-01 12:22:32">2022-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/90460439.html" title="this指向与箭头函数"><img src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/11.jpg" onerror='this.onerror=null,this.src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/friend_404.gif"' alt="this指向与箭头函数"></a><div class="content"><a class="title" href="/posts/90460439.html" title="this指向与箭头函数">this指向与箭头函数</a><time datetime="2022-03-30T13:01:02.000Z" title="发表于 2022-03-30 21:01:02">2022-03-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/447bd1ff.html" title="DOM事件总结"><img src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/13.jpg" onerror='this.onerror=null,this.src="https://cdn.jsdelivr.net/gh/Lesliewaong/Lesliewaong.github.io/img/friend_404.gif"' alt="DOM事件总结"></a><div class="content"><a class="title" href="/posts/447bd1ff.html" title="DOM事件总结">DOM事件总结</a><time datetime="2022-03-29T12:11:52.000Z" title="发表于 2022-03-29 20:11:52">2022-03-29</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2022 By Leslie Waong</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",preloader.endLoading())</script><div class="js-pjax"><script>(()=>{const t=document.getElementById("twikoo-count"),o=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo-k8ctnwg8j-1138964397-qqcom.vercel.app/",region:""},null))},e=()=>{twikoo.getCommentsCount({envId:"https://twikoo-k8ctnwg8j-1138964397-qqcom.vercel.app/",region:"",urls:[window.location.pathname],includeReply:!1}).then((function(o){t.innerText=o[0].count})).catch((function(t){console.error(t)}))},n=(n=!1)=>{"object"==typeof twikoo?(o(),n&&t&&setTimeout(e,0)):getScript("https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js").then(()=>{o(),n&&t&&setTimeout(e,0)})};btf.loadComment(document.getElementById("twikoo-wrap"),n)})()</script></div><div class="aplayer no-destroy" data-id="6995412795" data-server="tencent" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-preload="auto" data-autoplay="true" muted></div><script defer id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer color="0,0,255" opacity="0.7" zindex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors=["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(window.removeEventListener("scroll",window.tocScrollFn),window.removeEventListener("scroll",scrollCollect),"object"==typeof preloader&&preloader.initLoading(),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()})),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":0,"vOffset":0},"mobile":{"show":true,"scale":1},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"tagMode":false});</script></body></html>